
参考
- [Database Profiler](https://docs.mongodb.com/manual/tutorial/manage-the-database-profiler/)
- [Command Options About Profiler](https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-serviceexecutor)
- [Profiler Overhead](https://docs.mongodb.com/manual/tutorial/manage-the-database-profiler/#std-label-database-profiling-overhead)


数据库分析器功能可以收集数据库命令行在执行对正在运行的 mongod 服务实例操作后的详细信息，既包括 CRUD 操作，也有配置及管理命令操作。分析器将所有的数据收集保存到 `system.profile` 固定集合(capped collection)中，该集合会创建并存在于每个启用了分析器功能的数据库中。

缺省情况下是不启用分析器功能的。使用者可以在数据库级别或者服务实例级别配置各自的分析器级别以实现启用。

分析功能启用后，会对数据库性能和磁盘使用有一些影响。

本文档概括了对 profiler 一些关键的管理选项，更多信息可以参考:
- [Database Profiler Output](https://docs.mongodb.com/manual/reference/database-profiler/)
- [Profile Command](https://docs.mongodb.com/manual/reference/command/profile/)
- [db.currentOp()](https://docs.mongodb.com/manual/reference/method/db.currentOp/#mongodb-method-db.currentOp)

分析器操作要在 root 角色用户权限下进行。

### 名词说明

- Profiled Operations: 分析操作
- Profilier: 分析器
- Profiling Level: 分析级别
- Filter: 过滤器
- Sample Rate: 抽样率
- primary: 主从复制中的主库
- secondary: 主从复制中的从库

### 分析级别

可用等级如下:

| 等级 | 描述 |
|:-----|:----|
| 0    | 关闭分析器功能，不收集任何信息，这是默认等级 |
| 1    | 只收集那些高于 `slowms` 设定值操作信息 |
| 2    | 收集所有的操作信息 |

查看当前数据库 profiling 级别:
```js
db.getProfilingLevel()
```

查看当前数据库 profiling 状态信息:
```js
db.getProfilingStatus()
```
其执行输出类似如下:
```json
{ "was" : 0, "slowms" : 100, "sampleRate" : 1.0, "ok" : 1 }
```
- `was`: 当前分析级别
- `slowms`: 慢操作阈值，低于该值被视为慢
- `sampleRate`: 慢操作抽样率

```js
db.setProfilingLevel(0)
```
仅针对当前数据库有效。

在测试环境下进行开发时，需要对整个实例开启分析，此时分析会适用到所有的数据库:
```sh
mongod --profile 1 --slowms 15 --slowOpSampleRate 0.5
```

### 分析功能的启用和配置

程序员可以为 mongod 实例启用数据库的分析功能。这可以通过 `db.setProfilingLevel()` 传递一个大于 0 的参数来启用，之后 MongoDB 会在当前数据库中创建一个 `system.profile` 集合收集分析数据。

例如，如果要收集所有的操作信息，就可以像下面这样将分析级别设置为 2:
```js
db.setProfilingLevel(2)
```
执行结束后，会返回一条文档，它显示了执行该命令之前的分析器的状态信息:
```js
{ "was" : 0, "slowms" : 100, "sampleRate" : 1, "ok" : 1 }
```
通过 `ok` 可以判断该命令是否执行成功。

#### 全局与单个数据库分析功能设置

`slowms` 和 `sampleRate` 是全局有效的，这些设置会影响到实例中的所有数据库。

在客户端会话中通过 `profile` 指令或者 `db.setProfilingLevel()`，只对当前数据库有效。而通过命令行参数或者配置文件指定 `profile` 参数，设置对所有数据库有效。

#### 为慢操作指定阈值

缺省的阈值为 100 毫秒，可以选择如下方法的一种进行修改:
- 通过 `profile` 指令或者 `db.setProfilingLevel()` 设置 `slowms`
- 开启实例时通过命令行参数 `--slowms`
- 在配置文件中通过 `slowOpThresholdMs`

示例:
```js
db.setProfilingLevel(1, { slowms: 100 })
```

注意: 慢操作阈值的设置对所有数据库有效，也就是说程序员在某个数据库上修改阈值后，则所有数据库都会使用修改后的阈值。而且该阈值也会被 diagnostic 日志使用，所以为了避免因此而产生的性能衰减，通常将该值调得高一些。

#### 慢操作随机抽样分析

为了实现只对所有慢操作的随机抽样子集进行分析，可以通过如下方式之一指定一个期望抽样率:
- 通过 `profile` 指令或者 `db.setProfilingLevel()` 设置 `sampleRate`
- 开启实例时通过命令行参数 `--slowOpSampleRate`
- 在配置文件中通过 `slowOpSampleRate`

缺省时，`slowOpSampleRate` 为 1.0，表示会分析所有的慢操作。当 slowOpSampleRate 设置为 0 到 1 之间时，分析级别为 1 的数据库只会根据 sampleRate 设定的抽样率随机抽取一定的慢操作进行分析。

如下示例是抽查 42% 的慢操作:
```js
db.setProfilingLevel(1, {sampleRate: 0.42})
```
抽样率也适用于系统日志。

#### 设置过滤器来控制分析操作

程序员可以通过设置过滤器来控制哪些操作需要分析和输出日志。这可以通过以下之一实现:
- 通过 `profile` 指令或者 `db.setProfilingLevel()` 设置 `filter`
- 在配置文件中通过 `filter`

对于 mongod 实例，过滤器会影响到 diagnostic 日志和分析器(如果启用的话)，此时 `slowms` 和 `sampleRate` 选项对两者不再适用。

示例:
```js
db.setProfilingLevel( 2, { filter: { op: "query", millis: { $gt: 2000 } } } )
```
上面的命令将分析级别设置为 2，同时设置了过滤器，它只会输出查询操作且耗时超过 2s 的日志。


### 查看分析数据

分析器将数据库操作日志信息输出到 `system.profile` 集合中。所以可以通过访问这个集合来查看分析信息。

查看最近 10 条信息:
```js
db.system.profile.find().limit(10).sort( { ts : -1 } ).pretty()
```

查看所有除命令操作之外的信息:
```js
db.system.profile.find( { op: { $ne : 'command' } } ).pretty()
```

查看 mydb 数据库上 test 集合的信息:
```js
db.system.profile.find( { ns : 'mydb.test' } ).pretty()
```

查看大于 5 毫秒的信息:
```js
db.system.profile.find( { millis : { $gt : 5 } } ).pretty()
```

查看某个时间段的信息:
```js
db.system.profile.find({
ts : {
  $gt: new ISODate("2012-12-09T03:00:00Z"),
  $lt: new ISODate("2012-12-09T03:40:00Z")
}
}).pretty()
```

查看某个时间段的信息，为了更简洁，这里不再输出 `user` 信息，同时按 `millis` 降序排序:
```js
db.system.profile.find({
ts : {
  $gt: new ISODate("2011-07-12T03:00:00Z"),
  $lt: new ISODate("2011-07-12T03:40:00Z")
}
}, { user: 0 }).sort( { millis: -1 } )
```

此外，在一个开启了分析功能的数据库中执行 `show profile` 可以展示最近 5 条耗时超过 1 毫秒的执行操作:
```sh
show profile
```

### 分析器消耗

启用分析器会对数据库性能造成一定影响，尤其是在将分析级别设置为 2(输出所有分析数据)或者低阈值搭配分析级别 1 的情况下。此外，也会消耗磁盘空间，因为它会向 `system.profile` 集合和 MongoDB logfile 同时输出日志。

所以在生产环境上部署时，在启用分析器之前，要慎重考虑其对性能和安全的影响。

`system.profile` 集合是一个缺省容量大小为 1 兆字节(MB)的固定集合，通常可以存储几千条分析记录，但也会根据每个操作分析数据大小而有所波动。如果想要改变此集合的尺寸，如下:

#### 更改主库中集合的 system.profile

步骤如下:
1. 关闭分析器
2. 剔除 system.profile 集合
3. 创建新的 system.profile 集合
4. 重新启用分析器

比如，将集合调整为 4 MB 大小:
```js
db.setProfilingLevel(0)

db.system.profile.drop()

db.createCollection( "system.profile", { capped: true, size:4000000 } )

db.setProfilingLevel(1)
```
#### 更改从库中集合的 system.profile

停止从库实例，将其重新运行为一个独立实例，之后再遵循上述关于在主库中的操作。
