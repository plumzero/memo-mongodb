
参考: [Database Profiler Output](https://docs.mongodb.com/manual/reference/database-profiler/)

> 每次在执行数据库不同种类的操作的时候，为了分析性能，最好开启分析器，根据分析器输出信息进行优化。

启用分析器后，数据会被写入到当前数据库中的 `system.profile` 集合中，可以通过 MongoDB 通常查询方法来查看这些数据。

这里主要结合查询操作对分析输出进行说明。

查询语句为:
```js
db.getCollection('big_orders').find({
	$and: [
		{ symbol: { $in: [603518, 600876, 605399, 603050] } },
		{ status: { $in: [4, 7] } }
	]
},{
	_id: 0, id: 1, serverId: 1, orderId: 1, symbol: 1, account: 1, type: 1, status: 1, submitTime: 1, closeTime: 1, acceptTime: 1, nTime: 1
}).sort({ submitTime: 1, modify_time: -1 }).skip(5000).limit(10);
```

分析输出文件在[这里](profilier-query.json)

[这里](profilier-insert.json)也提供一份关于 insert 命令的测试输出。

[这里](测试数据记录.md)提供一份数据记录供参考。

接下来对测试输出中的一些字段进行说明。

### system.profile.op

操作类型。可选值有:
- command
- count
- distinct
- geoNear
- getMore
- group
- insert
- mapReduce
- query
- remove
- update

这里是 query 操作:
```json
  "op" : "query"
```

### system.profile.ns

操作目标的名字空间，用来指示在哪个库的哪个集合上进行的操作。

这里是 online 库 big_orders 集合:
```json
  "ns" : "online.big_orders"
```

### system.profile.command

该文档包含了关于此次操作的完整命令对象。

这里 find 的目标是 big_orders 集合，
```json
"command" : {
    "find" : "big_orders", 
    "filter" : {
        "$and" : [
            {
                "symbol" : {
                    "$in" : [
                        603518.0, 
                        600876.0, 
                        605399.0, 
                        603050.0
                    ]
                }
            }, 
            {
                "status" : {
                    "$in" : [
                        4.0, 
                        7.0
                    ]
                }
            }
        ]
    }, 
    "sort" : {
        "submitTime" : 1.0, 
        "modify_time" : -1.0
    }, 
    "projection" : {
        "_id" : 0.0, 
        "id" : 1.0, 
        "serverId" : 1.0, 
        "orderId" : 1.0, 
        "symbol" : 1.0, 
        "account" : 1.0, 
        "type" : 1.0, 
        "status" : 1.0, 
        "submitTime" : 1.0, 
        "closeTime" : 1.0, 
        "acceptTime" : 1.0, 
        "nTime" : 1.0
    }, 
    "skip" : NumberInt(5000), 
    "limit" : NumberInt(10), 
    "batchSize" : NumberInt(50), 
    "$db" : "online", 
    "lsid" : {
        "id" : UUID("63e02322-d462-4353-ab5e-e2f728ba357c")
    }
}
```

### system.profile.keysExamined

执行该操作时 MongoDB 扫描的索引键的数量。这里是 0，表示没有扫描索引。
```json
  "keysExamined" : NumberInt(0)
```

通常情况下，如果 `keysExamined` 远高于 `nreturned`，就说明数据库扫描了很多的索引键。创建或调整索引可以提高查询效率。

keysExamined 对以下命令或操作有效:
- aggregate
- find(OP_QUERY and command)
- findAndModify
- count
- distinct
- getMore(OP_GET_MORE and command)
- mapReduce
- delete
- update

### system.profile.docsExamined

执行该操作扫描的文档数量。这里进行了全表扫描，一共是 2010177 条，可以想像到的是，还是很费劲的。
```json
  "docsExamined" : NumberInt(2010177)
```

docsExamined 对以下命令或操作有效:
- aggregate
- find(OP_QUERY and command)
- findAndModify
- count
- distinct
- getMore(OP_GET_MORE and command)
- mapReduce
- delete
- update

### system.profile.hasSortStage

true 表示查询不能使用索引的排序功能来返回请求的排序结果。该值只有在为 true 时才会出现在分析输出中。

这里是 true，表示不能使用索引的排序功能:

这里使用的两个排序字段为 submitTime 和 modify_time，由于没有为它们建立索引，所以这里为 true。
```json
  "hasSortStage" : true
```
不仅如下，如果上面的两个排序字段只有一个建立了索引，该值也为 true。只有两个字段均建立索引，才为 false 。

hasSortStage 对以下命令或操作有效:
- find(OP_QUERY and command)
- getMore(OP_GET_MORE and command)
- findAndModify
- mapReduce
- aggregate

### system.profile.numYield

本操作让步于其他操作的次数。通常，当某个操作需要访问还没有完全读入到内存的数据时，它就会让步于其他操作(内存中已保有其全部数据)。

```json
  "numYield" : NumberInt(2070)
```

### system.profile.nreturned

操作返回的文档数量。

```json
  "nreturned" : NumberInt(10)
```

### system.profile.locks

该部分会提供在操作期间持有的各种锁类型和锁模式的信息。

可能的锁类型有:

| 锁类型  | 描述  |
|:-------|:------|
| ParallelBatchWriterMode | 该种锁用于并行批量写模式 |
| ReplicationStateTransition | 为 [replica set member state](https://docs.mongodb.com/manual/reference/replica-states/) 传输的锁 |
| Global | 全局锁 |
| Database | 数据库锁 |
| Collection | 集合锁 |
| Mutex | 互斥锁 |
| Metadata | 元数据锁 |
| oplog | oplog 上的锁 |

锁类型上可能的锁模式有:

| 锁模式 | 描述  |
|:------|:------|
| R     | 共享锁 |
| W     | 独占锁 |
| r     | 意向共享锁 |
| w     | 意向独占锁 |

各个锁类型返回的锁信息可以包括:
- `system.profile.locks.acquireCount`: 在指定模式下操作时获取锁的次数
- `system.profile.locks.acquireWaitCount`: 因为锁在冲突模式下被其他持有，操作要获得锁而等待的次数
- `system.profile.locks.timeAcquiringMicros`: 操作因为要获得锁而等待的总的累计时间，微秒计。
- `system.profile.locks.deadlockCount`: 等待获取锁时，遭遇死锁的次数

```json
  "locks" : {
    "ReplicationStateTransition" : {
      "acquireCount" : {
        "w" : NumberLong(1)
      }
    }, 
    "Global" : {
      "acquireCount" : {
        "r" : NumberLong(2072)
      }
    }, 
    "Mutex" : {
      "acquireCount" : {
        "r" : NumberLong(1)
      }
    }
  }
```

### system.profile.storage

该部分提供了存储引擎数据的指标和操作的等待时间。

具体存储指标只有在大于 0 时才会在输出中出现。

- `system.profile.storage.data.bytesRead`: 本操作从磁盘读取缓存(cache)中的字节数
- `system.profile.storage.data.timeReadingMicros`: 本操作从磁盘中读取所用的时间，微秒计
- `system.profile.storage.data.bytesWritten`: 本操作从缓存写入缓盘中的字节数
- `system.profile.storage.data.timeWritingMicros`: 本操作写入到磁盘所用的时间，微秒计
- `system.profile.storage.timeWaitingMicros.cache`: 本操作因为要获得一个 schema 锁(如果修改 schema 的话)而等待的微秒时间
- `system.profile.storage.timeWaitingMicros.handleLock`: 本操作因数据处理需要等待获取锁所花费的微秒时间

```json
  "storage" : {
    "data" : {
      "bytesRead" : NumberLong(362936064), 
      "timeReadingMicros" : NumberLong(3989319)
    }
  }
```

### system.profile.responseLength

本操作返回的结果文档的字节数。大的 responseLength 会影响性能。

为了限制一个查询操作结果文档的尺寸，可以:
- [Projections](https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/#std-label-read-operations-projection)
- [limit() 方法](https://docs.mongodb.com/manual/reference/method/cursor.limit/#mongodb-method-cursor.limit)
- [batchSize() 方法](https://docs.mongodb.com/manual/reference/method/cursor.limit/#mongodb-method-cursor.limit)

```json
  "responseLength" : NumberInt(1706)
```

### system.profile.protocol

MongoDB Wire Protocol 的请求消息格式。

```json
  "protocol" : "op_msg"
```

### system.profile.millis

从 mongod 角度看，本操作从开始执行到结束执行所花费的时间，毫秒计。

```json
  "millis" : NumberInt(6733)
```

### system.profile.planSummary

执行计算概括。

```json
  "planSummary" : "COLLSCAN"
```
大概意思是全集合扫描。

### system.profile.execStats

该内容包含了对于查询操作的执行统计信息。对于其他操作该部分是没有的。

以树状形式展示统计信息，每个节点提供了在查询操作的相应阶段执行的操作的统计信息。

节点中可能包括:
- `system.profile.execStats.stage`: 执行查询时操作执行各阶段部分的描述性名称
  - `COLLSCAN`: 集合扫描
  - `IXSCAN`: 扫描索引
  - `FETCH`: 检索文档
- `system.profile.execStats.inputStages`:

```json
"execStats" : {
    "stage" : "PROJECTION_SIMPLE", 
    "nReturned" : NumberInt(10), 
    "executionTimeMillisEstimate" : NumberInt(3589), 
    "works" : NumberInt(2015190), 
    "advanced" : NumberInt(10), 
    "needTime" : NumberInt(2015179), 
    "needYield" : NumberInt(0), 
    "saveState" : NumberInt(2070), 
    "restoreState" : NumberInt(2070), 
    "isEOF" : NumberInt(1), 
    "transformBy" : {

    }, 
    "inputStage" : {
        "stage" : "SKIP", 
        "nReturned" : NumberInt(10), 
        "executionTimeMillisEstimate" : NumberInt(3577), 
        "works" : NumberInt(2015190), 
        "advanced" : NumberInt(10), 
        "needTime" : NumberInt(2015179), 
        "needYield" : NumberInt(0), 
        "saveState" : NumberInt(2070), 
        "restoreState" : NumberInt(2070), 
        "isEOF" : NumberInt(1), 
        "skipAmount" : NumberInt(0), 
        "inputStage" : {
            "stage" : "SORT", 
            "nReturned" : NumberInt(5010), 
            "executionTimeMillisEstimate" : NumberInt(3559), 
            "works" : NumberInt(2015190), 
            "advanced" : NumberInt(5010), 
            "needTime" : NumberInt(2010179), 
            "needYield" : NumberInt(0), 
            "saveState" : NumberInt(2070), 
            "restoreState" : NumberInt(2070), 
            "isEOF" : NumberInt(1), 
            "sortPattern" : {
                "submitTime" : NumberInt(1), 
                "modify_time" : NumberInt(-1)
            }, 
            "memLimit" : NumberInt(104857600), 
            "limitAmount" : NumberInt(5010), 
            "type" : "simple", 
            "totalDataSizeSorted" : NumberInt(3455030), 
            "usedDisk" : false, 
            "inputStage" : {
                "stage" : "COLLSCAN", 
                "filter" : {
                    "$and" : [
                        {
                            "status" : {
                                "$in" : [
                                    4.0, 
                                    7.0
                                ]
                            }
                        }, 
                        {
                            "symbol" : {
                                "$in" : [
                                    600876.0, 
                                    603050.0, 
                                    603518.0, 
                                    605399.0
                                ]
                            }
                        }
                    ]
                }, 
                "nReturned" : NumberInt(5386), 
                "executionTimeMillisEstimate" : NumberInt(3556), 
                "works" : NumberInt(2010179), 
                "advanced" : NumberInt(5386), 
                "needTime" : NumberInt(2004792), 
                "needYield" : NumberInt(0), 
                "saveState" : NumberInt(2070), 
                "restoreState" : NumberInt(2070), 
                "isEOF" : NumberInt(1), 
                "direction" : "forward", 
                "docsExamined" : NumberInt(2010177)
            }
        }
    }
}
```

### system.profile.ts

执行本次操作的时间戳。

```json
  "ts" : ISODate("2022-01-07T02:37:43.330+0000")
```

### system.profile.client

在哪台机器上执行的本次操作。

```json
  "client" : "192.168.3.5"
```

### system.profile.appName

```json
  "appName" : "Studio 3T"
```

### system.profile.allUsers

```json
"allUsers" : [
  {
    "user" : "mongoadmin", 
    "db" : "admin"
  }
]
```

### system.profile.user

```json
  "user" : "mongoadmin@admin"
```
