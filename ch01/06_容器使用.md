
- [mongo容器的使用](https://hub.docker.com/_/mongo?tab=description)
- [MongoDB命令行参数](https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-serviceexecutor)

### 创建

一般生产环境下创建流程如下:
1. 非认证方式运行一个容器
```js
docker run --rm --name some-mongo -d -p 47017:27017 -v /mgdata/db:/data/db mongo --profile 1 --slowms 100
```

2. 进入该容器数据库，设置必要权限
```js
docker exec -it some-mongo /bin/bash
```

在数据库会话环境中执行如下命令:
```js
use admin

db.createUser(
    {
        user: "plumzero",
        pwd: "mypassword",
        roles: [
            {
                role: "userAdminAnyDatabase", db: "admin"
            },
            "readWriteAnyDatabase"
        ]
    }
)
# 对所有数据库只读
db.createUser({user:"readall",pwd:"Bureido6526",roles:["readAnyDatabase"]})
# 对所有数据库可读写
db.createUser({user:"writeall",pwd:"Bureido6526",roles:["readWriteAnyDatabase"]})
# 对指定数据库(online)只读
db.createUser({user:"readon",pwd:"Bureido6526",roles:[{role:"read",db:"online"}]})
# 对指定数据库(online)可读写
db.createUser({user:"writeon",pwd:"Bureido6526",roles:[{role:"readWrite",db:"online"}]})
# 对指定数据库(offline)只读
db.createUser({user:"readoff",pwd:"Bureido6526",roles:[{role:"read",db:"offline"}]})
# 对指定数据库(offline)可读写
db.createUser({user:"writeoff",pwd:"Bureido6526",roles:[{role:"readWrite",db:"offline"}]})

# 最高权限
db.createUser({user:"root",pwd:"123456",roles:[{role:"root",db:"admin"}]})
```

3. 停止容器，之后以认证方式启动
```js
docker stop some-mongo
docker run --rm --name some-mongo -d -p 47017:27017 -v /mgdata/db:/data/db mongo --auth --profile 1 --slowms 100
```

### 访问

访问 mongodb 容器中数据库的两种方式。

一种是先进入容器会话环境，之后通过 mongo 客户端进入:
```js
$ docker exec -it some-mongo /bin/bash
root# mongo -u writeall -p Bureido6526 --authenticationDatabase admin
```
或者直接从当前 shell 会话端进入:
```js
$ docker run -it --rm some-mongo mongo --host 192.168.2.104:47017 -u writeall -p Bureido6526 --authenticationDatabase admin
```

### 通过命令行传入参数而不是配置

MongoDB 的多数配置可以通过为 `mongod` 指定参数方式进行设置。镜像入口点创建之后，就可以将参数传递给 `mongod` 使用。下例即为设置 MongoDB 为 [threading and execution model](https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-serviceexecutor) 启动的示例:
```js
$ docker run --name some-mongo -d mongo --serviceExecutor adaptive
```
其中 `--serviceExecutor adaptive` 是命令 `mongod` 的参数选项，这里通过在入口点 mongo 之后将其传入，由容器的 `mongod` 使用。

其等价于 `docker-compose.yml` 文件如下内容:
```yaml
version: '3.1'
services:
  mongo:
    image: mongo
    command: --serviceExecutor adaptive     
```

注意: 测试发现不是所有的 `mongod` 参数都可以通过上面这种方式传入(或者即便可以传入但也未必生效)，具体允许传入哪些参数，可以通过如下命令查看:
```js
$ docker run -it --rm mongo --help
```
引申开来，你在真机上写一个关于 mongod 的配置，因为某些配置项参数的原因，将配置用到容器上，未必可以成功启动运行。

不妨将其这样映射:
```js
$ docker run --name some-mongo -d mongo
```

访问容器:
```js
$ docker run -it --rm mongo mongo --host 192.168.3.40
```
如果在容器所在主机上访问容器，则 `--host` 也可以使用容器名称代替。

### 设置 WiredTiger 缓存大小上限

缺省情况下，MongoDB 会根据当前容器宿主机总内存对 `wiredTigerCacheSizeGB` 进行一定比例设置，这有可能会超过开始时为容器分配的内存大小。这种情况下就需要合理设置缓存大小:
```js
docker run --name some-mongo -d mongo --wiredTigerCacheSizeGB 1.5
```
执行上面的命令会将缓存大小设置为 1.5 GB。

### 使用自定义的配置文件

如果要进行更复杂的配置，就需要用到配置文件了。`mongod` 缺省是不会读取配置文件的，通过 `-f` 或 `--config` 选项可以指定一个自定义的配置文件路径。

将创建的自定义配置文件上传到容器中的方法有两个:
1. 在 `Dockerfile` 文件中通过 `FROM mongo`
2. 将其从宿主机挂载到容器

如下示例采用第 2 种方式指定配置文件进行启动，`/my/custom/mongod.conf` 是配置文件路径:
```js
$ docker run --name some-mongo -v /my/custom:/etc/mongo -d mongo --config /etc/mongo/mongo.conf
```
它将宿主机 `/my/custom` 目录下的文件挂载到容器 `/etc/mongo` 目录下，这样容器就可以找到配置文件并进行启动了。

### 环境变量

当启动一个 mongo 镜像时，可以通过在执行 `docker run` 命令时传入一些环境变量的方式，对 MongoDB 实例的初始化进行调整。

请注意，如果使用已经包含数据库的数据目录启动容器，下面的任何变量都不会产生任何影响: 在容器启动时，任何预先存在的数据库都将保持不变。

通过 `MONGO_INITDB_ROOT_USERNAME` 和 `MONGO_INITDB_ROOT_PASSWORD` 环境变量可以创建一个用户并为其设置密码，该用户会添加到 `admin` 认证库中，其权限角色为 `root`，是一个超级用户。
```js
$ docker run --rm --name some-mongo -d -p 27017:27017 -e MONGO_INITDB_ROOT_USERNAME=mongoadmin -e MONGO_INITDB_ROOT_PASSWORD=secret mongo
```
这里因为要做测试，所以指定了 `--rm` 参数，表示一旦停止运行即删除容器。生产时大可不必。

通过 `ps -ef | grep -v grep | grep mongod` 命令可以看到 mongod 进程有了 `--auth` 参数，表示开启了认证:
```sh
  999       59371  59346  1 09:49 ?        00:00:05 mongod --auth --bind_ip_all
```
你可以通过如下两种方式访问数据库:

一种是先进入容器会话环境，之后通过 mongo 客户端进入:
```js
$ docker exec -it some-mongo /bin/bash
root# mongo -u mongoadmin -p secret --authenticationDatabase admin
```
或者直接从当前 shell 会话端进入:
```js
$ docker run -it --rm mongo mongo --host 192.168.3.40:27017 -u mongoadmin -p secret --authenticationDatabase admin
```

### 将数据存储在宿主机磁盘

步骤如下:

1.在宿主机上的合适位置创建一个数据目录，比如 `/my/own/datadir`

2.像下面这样运行容器:

```js
$ docker run --name some-mongo -v /my/own/datadir:/data/db -d mongo
```
`-v /my/own/datadir:/data/db` 部分表示将宿主机的 `/my/own/datadir` 挂载到容器的 `/data/db` 上。

### 最后的命令

MongoDB 就一个服务，所以需要建立一个端口映射，这可以通过 `-p` 参数实现。

MongoDB 作为一个数据库，如果想要将数据存储到外部磁盘上，还需要建立对文件系统的映射，这可以通过 `-v` 参数实现。

`-p` 或者 `-v` 参数可以在同一个命令行参数中多次使用，以便映射多个端口或者多个文件路径。

在 MongoDB 中，通常需要建立一个端口映射(一般是标准 MongoDB 端口 27017)，以及两个文件路径，分别对应配置和数据存储目录。在 mongo 容器中，其默认路径分别是:
- 配置目录: `/etc/mongo`
- 数据目录: `/data/db`

以文件的形式配置参数还有一些问题，这里采用在命令行中通过入口点传递参数:
```js
$ docker run --rm --name some-mongo -d -p 27017:27017   \
  -v /mgdata/db:/data/db      \
  -e MONGO_INITDB_ROOT_USERNAME=mongoadmin -e MONGO_INITDB_ROOT_PASSWORD=secret mongo --auth --profile 1 --slowms 100
```

预期但失败的配置:
```js
$ docker run --rm --name some-mongo -d -p 27017:27017   \
  -v /mgdata/db:/data/db          \
  -v /mgdata/log:/var/log/mongodb \
  -v /mgdata/conf:/data/conf      \
  -e MONGO_INITDB_ROOT_USERNAME=mongoadmin -e MONGO_INITDB_ROOT_PASSWORD=secret mongo --config /data/conf/mongod.conf
```
如果没有目录，执行命令后程序会自行创建。但如果没有文件，则会执行失败。

一份供参考的[配置文件](mongod.yml)。