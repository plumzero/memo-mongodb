
### 示例一

```sql
    CREATE TABLE atab
    (
        date            CHAR(8)         NOT NULL,
        id              CHAR(8)         NOT NULL,
        balance         INTEGER         NOT NULL
    );
```

```sql
    CREATE TABLE dtab
    (
        date            CHAR(8)         NOT NULL,
        accountid       CHAR(8)         NOT NULL,
        direction       INTEGER         NOT NULL,
        cost            REAL            NOT NULL
    );
```

```sql
    INSERT INTO atab VALUES('20220601', '1001', 12100);
    INSERT INTO atab VALUES('20220601', '1002', 12101);
    INSERT INTO atab VALUES('20220601', '1003', 12102);
    INSERT INTO atab VALUES('20220602', '1003', 10030);
    INSERT INTO atab VALUES('20220602', '1004', 10040);
    INSERT INTO atab VALUES('20220603', '1002', 10020);
    INSERT INTO atab VALUES('20220603', '1003', 10030);
```

```sql
    INSERT INTO dtab VALUES('20220601', '1001', -1, 1.2100);
    INSERT INTO dtab VALUES('20220601', '1005', -1, 1.2101);
    INSERT INTO dtab VALUES('20220602', '1003', -1, 1.0010);
    INSERT INTO dtab VALUES('20220602', '1004',  1, 1.0020);
    INSERT INTO dtab VALUES('20220604', '1002',  1, 1.0060);
    INSERT INTO dtab VALUES('20220604', '1003', -1, 1.0080);
```

```sql
    SELECT a.date, a.id, a.balance, d.direction, d.cost
        FROM atab AS a
            INNER JOIN dtab AS d
                ON a.date = d.date AND a.id = d.accountid;
```
输出结果:
```sh
   date   |    id    | balance | direction | cost  
----------+----------+---------+-----------+-------
 20220601 | 1001     |   12100 |        -1 |  1.21
 20220602 | 1003     |   10030 |        -1 | 1.001
 20220602 | 1004     |   10040 |         1 | 1.002
(3 rows)
```

用 MongoDB 实现同样的效果:

```js
    db.atab.insert([
        {date:'20220601', id:'1001', balance:12100},
        {date:'20220601', id:'1002', balance:12101},
        {date:'20220601', id:'1003', balance:12102},
        {date:'20220602', id:'1003', balance:10030},
        {date:'20220602', id:'1004', balance:10040},
        {date:'20220603', id:'1002', balance:10020},
        {date:'20220603', id:'1003', balance:10030}
    ])
```

```js
    db.dtab.insert([
        {date:'20220601', accountid:'1001', direction:-1, cost:1.2100},
        {date:'20220601', accountid:'1005', direction:-1, cost:1.2101},
        {date:'20220602', accountid:'1003', direction:-1, cost:1.0010},
        {date:'20220602', accountid:'1004', direction:1, cost:1.0020},
        {date:'20220604', accountid:'1002', direction:1, cost:1.0060},
        {date:'20220604', accountid:'1003', direction:-1, cost:1.0080}
    ])
```

```js
    db.atab.aggregate([
        {
            $lookup: {
                from: 'dtab',
                let: { atab_date: '$date', atab_account: '$id' },
                pipeline: [
                    {
                        $match: {
                            $expr: {
                                $and: [
                                    { $eq: ['$date', '$$atab_date'] },
                                    { $eq: ['$accountid', '$$atab_account'] }
                                ]
                            }
                        }
                    },
                    {
                        $project: { _id:0, date: 0, accountid: 0 }
                    }
                ],
                as: 'fromdtab'
            }
        },
        {
            $unwind: '$fromdtab'
        },
		{
			$replaceRoot: { newRoot: { $mergeObjects: [ '$fromdtab', '$$ROOT' ] } }
		},
        { $project: { fromdtab: 0, _id: 0 } }
    ])
```

输出结果:
```js
{ "direction" : -1, "cost" : 1.21, "date" : "20220601", "id" : "1001", "balance" : 12100 }
{ "direction" : -1, "cost" : 1.001, "date" : "20220602", "id" : "1003", "balance" : 10030 }
{ "direction" : 1, "cost" : 1.002, "date" : "20220602", "id" : "1004", "balance" : 10040 }
```

### 示例二


```sql
    CREATE TABLE orders
    (
        item            CHAR(16)        NOT NULL,
        price           REAL            NOT NULL,
        ordered         INTEGER         NOT NULL
    );
```

```sql
    INSERT INTO orders VALUES('almonds', 12, 2),('pecans', 20, 1),('cookies', 10, 60);
```

```sql
    CREATE TABLE warehouses
    (
        stock_item  CHAR(16)    NOT NULL,
        warehouse   CHAR(1)     NOT NULL,
        instock     INTEGER     NOT NULL
    );
```

```sql
    INSERT INTO warehouses VALUES('almonds','A',120),('pecans','A',80),('almonds','B',60),('cookies','B',40),('cookies','A',80);
```

```sql
    SELECT o.item, o.price, o.ordered, w.warehouse, w.instock
        FROM orders AS o
            INNER JOIN warehouses AS w
                ON o.item = w.stock_item AND w.instock >= o.ordered;
```
输出如下:
```sh
       item       | price | ordered | warehouse | instock 
------------------+-------+---------+-----------+---------
 almonds          |    12 |       2 | B         |      60
 almonds          |    12 |       2 | A         |     120
 pecans           |    20 |       1 | A         |      80
 cookies          |    10 |      60 | A         |      80
(4 rows)
```

用 MongoDB 实现同样的效果:

```js
    db.orders.insert([
        { "_id" : 1, "item" : "almonds", "price" : 12, "ordered" : 2 },
        { "_id" : 2, "item" : "pecans", "price" : 20, "ordered" : 1 },
        { "_id" : 3, "item" : "cookies", "price" : 10, "ordered" : 60 }
    ])
```

```js
    db.warehouses.insert([
        { "_id" : 1, "stock_item" : "almonds", warehouse: "A", "instock" : 120 },
        { "_id" : 2, "stock_item" : "pecans", warehouse: "A", "instock" : 80 },
        { "_id" : 3, "stock_item" : "almonds", warehouse: "B", "instock" : 60 },
        { "_id" : 4, "stock_item" : "cookies", warehouse: "B", "instock" : 40 },
        { "_id" : 5, "stock_item" : "cookies", warehouse: "A", "instock" : 80 }
    ])
```

```js
    db.orders.aggregate([
        {
            $lookup: {
                from: 'warehouses',
                let: { order_item: '$item', order_qty: '$ordered' },  // 将 orders 表中的 item 和 ordered 字段视为联查键，分别别名为 order_item 和 order_qty  
                pipeline: [
                    {
                        $match: {
                            $expr: { 
                                $and: [
                                    { $eq: [ '$stock_item',  '$$order_item' ] },
                                    { $gte: [ '$instock', '$$order_qty' ] }
                                ]
                            }
                        }
                    },
                    { $project: { stock_item: 0, _id: 0 } }     // 将 warehouses 表中的某些字段屏蔽
                ],
                as: 'stockdata'
            }
        },
		{
			$unwind: '$stockdata'
		},
		{
			$replaceRoot: { newRoot: { $mergeObjects: [ '$stockdata', '$$ROOT' ] } }
		},
		{ $project: { stockdata: 0, _id: 0 } }
    ])
```
输出如下:
```sh
{ "warehouse" : "A", "instock" : 120, "item" : "almonds", "price" : 12, "ordered" : 2 }
{ "warehouse" : "B", "instock" : 60, "item" : "almonds", "price" : 12, "ordered" : 2 }
{ "warehouse" : "A", "instock" : 80, "item" : "pecans", "price" : 20, "ordered" : 1 }
{ "warehouse" : "A", "instock" : 80, "item" : "cookies", "price" : 10, "ordered" : 60 }
```