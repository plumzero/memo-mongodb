
### 参考

- [关于validate()的输出](https://docs.mongodb.com/v5.0/reference/command/validate)
- [状态码](https://docs.mongodb.com/v5.0/reference/exit-codes/#mongodb-error-5)
- [Truncate a collection](https://stackoverflow.com/questions/16493902/truncate-a-collection#)


### 全删除的方式

通过以下三种方式进行全删除耗时对比:
- `remove({})`
- `deleteMany({})`
- 先 drop 再建索引

remove 和 deleteMany 在进行操作时会在集合级别加锁，drop 操作时会在数据库级别加锁。


### 如何判断一个集合是否存在

1. 通过 `db.coll.find().count() == 0` 可以判断某个集合是否为空，当集合不存在或者集合存在但文档数为空时，均为真。

2. 通过 `db.coll.validate()` 会返回关于集合的[有效性信息](https://docs.mongodb.com/v4.4/reference/command/validate/#std-label-validate-output)，可以根据返回的 json 信息中的 `valid` 字段(布尔类型)来判断该集合是否可用。而 `errmsg` 则会描述 valid 为 false(不可用)时的具体原因，比如当集合不存在时，其错误描述为: `Collection 'offline.coll' does not exist to validate.`:
```json
{
    "ok" : 0,
    "errmsg" : "Collection 'offline.coll' does not exist to validate.",
    "code" : 26,
    "codeName" : "NamespaceNotFound",
    "valid" : false
}
```

当然集合不可用并不代表这个集合一定不存在，想要判断集合是否存在，可能还要进行一些其他操作。

其中一种判断集合是否存在的伪码示意:
```js
    if db.coll.validate().valid == false && db.coll.validate().code == 26 {
        db.coll.drop()
        db.createCollection("coll")
        db.createIndex({status: 1})
    } else {
        db.coll.deleteMany({})
    }
```


### 测试

文档数量: 10050885 条

测试结果:

| 方式 | 耗时(毫秒) |
|:----|:-----------|
| remove | 306953 |
| deleteMany | 303964 |
| drop+createCollection+createIndex | <100 |


### 结果与建议

1. 在进行全集合删除时，MongoDB 没有像 SQL `TRUNCATE` 简单高效的命令。不过可以通过 `drop + createCollection + createIndex` 达到同样的效果。
